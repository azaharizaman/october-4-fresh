# Copilot Instructions for oc-polaris

## Project Overview
- This project is a modular OctoberCMS application, extended with custom plugins and themes for the One Medicare Sdn Bhd.
- Core structure: `modules/` (core features), `plugins/omsb/*` (domain-specific plugins), `themes/` (contain css and site structure definition which is less important since most of the user will be accessing the backend side of OctoberCMS and that part look and feel is defined by the default OctoberCMS Backend theme), and `config/` (environment/configuration).
- Built on top of OctoberCMS latest version that utilized Laravel 12 with PHP 8.2 and above supported. All custom codebase (other than config) resides within `/plugins/omsb` folder and strictyly adhere to OctoberCMS conventions for plugins structure.

## Key Architectural Patterns
- **Modules**: Core features (e.g., `backend`, `cms`, `editor`, `media`, `system`) are in `modules/`. Each module is self-contained with its own controllers, models, assets, and tests.
- **Plugins**: Domain-specific logic is in `plugins/omsb/*`. Each plugin follows standardized structure:
  ```
  controllers/     # Lean controllers, request/response handling only (https://docs.octobercms.com/4.x/extend/system/controllers.html)
  services/        # Business logic classes (e.g., AdjustmentService)
  models/          # Eloquent models with validation traits
  behaviors/       # OctoberCMS repeatable controller behaviors or model behaviors (https://docs.octobercms.com/4.x/extend/system/behaviors.html)
  updates/         # Database migration files
  helpers/         # Utility/helper functions (e.g., StaffHelper, WorkflowHelper)
  classes/         # Jobs, events, listeners, abstractions, etc each within its own subfolder
  tests/           # PHPUnit tests extending PluginTestCase
  ```
- **Views**: Backend views use Twig templates located in `views/` within each plugin's controller (https://docs.octobercms.com/4.x/extend/system/views.html).
- **Themes**: Frontend themes (e.g., `thebakerdev-zenii`) use TailwindCSS and Laravel Mix for asset management. See each theme's `README.md` for build instructions.
- **Config**: All environment and service configuration is in `config/`.

## Developer Workflows
- **Install dependencies**: Use `composer install` for PHP and `npm install` in theme directories for JS/CSS.
- **Build assets**: For themes, run `npm run dev` or `npm run watch` in the theme directory (e.g., `themes/thebakerdev-zenii`).
- **Testing**:
  - Core and plugin tests: Run `phpunit` in the project root or in a plugin directory with a `phpunit.xml`.
  - Plugin tests use `PluginTestCase` and may require plugin registration/bootstrapping in `setUp()`.
  - To change the test DB engine, set `useConfigForTesting` in `config/database.php` or override with `config/testing/database.php`.
- **Database migrations**: Use `php artisan october:migrate` (core) and `php artisan plugin:refresh Vendor.Plugin` (will destroy db data so not to be run on production).

## Project-Specific Conventions
- **Service Layer**: Business logic is extracted into service classes (e.g., `AdjustmentService`, `PurchaseRequestService`) that handle complex operations and maintain separation of concerns.
- **Model Architecture**: Models use OctoberCMS models traits (https://docs.octobercms.com/4.x/extend/database/traits.html) and follow PHP 8.2 standards with return type declarations. Many models include morphTo relationships for flexible associations.
- **Plugin structure**: Always use OctoberCMS plugin conventions. TSI plugins follow modern PHP 8.0 standards with comprehensive PHPDoc blocks.
- **Testing**: Extend `PluginTestCase` for plugin tests. Register/boot plugins in `setUp()` if testing with dependencies.
- **Asset management**: Themes use TailwindCSS and Laravel Mix. Edit `tailwind.config.js` for theme customization.
- **Event-driven extensions**: Editor extensions are registered via the `editor.extension.register` event (see `modules/editor/README.md`).
- **Naming**: TSI plugins are namespaced under `Tsi\` and follow clear domain separation (Inventory, Procurement, Organization, etc.).

## Integration Points
- **Laravel Foundation**: OctoberCMS is built on Laravel 6.0; use Laravel features where appropriate, but follow OctoberCMS conventions for structure.
- **Vue Components**: Editor and some modules use Vue for client-side features (see `modules/editor/vuecomponents/`).
- **External assets**: Themes may use external icon sets, illustrations from [unDraw](https://undraw.co/), and Tailwind plugins.
- **Data Feeding**: The Feeder plugin provides activity tracking via morphTo relationships - models can have feeds that track user actions (e.g., `$user->first_name created this $model->title`).
- **Cross-plugin dependencies**: Many plugins reference each other (e.g., Workflow integrates with Organization for staff management, Inventory connects to Organization for site/unit structure).

## Domain-Specific Plugin Details (Detail Instructions, please refer to each plugin's README for full docs)
- **Organization**: Core plugin managing companies, sites, sites-staff, warehouses with multi-hierarchy structure. hierarchical staff structure enables multi level approval workflows where staff with creator permission can create records and staff with approver permission can approve records created by staff under them in the hierarchy. This permission also is identified by transaction type, or in this application is called a Document. An creator or approver may have one or multiple document that he/she can create and/or approve. Every creator and approver staff must be assigned to a site or sites and each one will have a ceiling of how much a transaction value they can create or approve.
- **Inventory**: This plugin is 1 of the 2 core operations plugin that handle inventory management and is linked tightly with the procurement management handled by procurement plugin. Inventory plugin handle inventory stock management, stock adjustment, stock transfer, stock opname, stock reservation, stock allocation, stock picking and packing, delivery order management, goods receipt management, item management with item categories and item units management, inventory valuation report generation and inventory movement report generation. Inventory plugin also integrate with Organization plugin to manage sites and warehouses structure along with staff hierarchy structure for approval workflow purpose. Inventory plugin also integrate with Workflow plugin to define the workflow for each document type in the inventory module (e.g. Receiving Stocks, Stock Adjustment, Stock Transfer) along with status transition rules and approver roles definition. Items are structured in two level of definition; the Master Item definition that define the item code, item name, item category, item unit, item type (consumable or non-consumable), and other general information about the item; and the Item Stock Keeping Unit (SKU) definition that define the specific SKU for each master item along with its own barcode, serial number (if applicable). The Master Item (Items) can be seen as the definition of the items, then the Warehouse Items (or stock items) where real transactions happens are defined at warehouse level and each warehouse will have its own stock quantity for each item SKU defined in the Master Item definition. In another word, Master Items does not have QoH (Quantity on Hand) defined, the QoH is only defined at warehouse level for each item SKU. Each inventory transaction document (e.g. Stock Adjustment, Stock Transfer, Goods Receipt) will affect the stock quantity of the item SKU at the warehouse level. Inventory plugin also integrate with Feeder plugin to keep track of all activities performed by the users in the system related to inventory management. To keep the movement of every warehouse item qty precisely recorded, it adopts a system much like double entry accounting system where every increase in qty must be matched with a decrease in qty in another warehouse or another location (e.g. in-transit). As an example, when goods are received from a vendor, the Goods Receipt document will increase the qty of the item SKU in the receiving warehouse while at the same time decrease the qty of the item SKU in the In-Transit warehouse (a virtual warehouse that represent items that are in transit). This way, the total qty of the item SKU across all warehouses will always be accurate and can be traced back to each transaction document that affected the qty. The model named InventoryLedger is the one that keep track of all qty movement for each warehouse item SKU along with reference to the document that caused the qty movement. This ledger system also enable accurate inventory valuation report generation based on various costing method (e.g. FIFO, LIFO, Average Cost) since every qty movement is recorded along with its cost and reference document. When a user views any ledger-related document (e.g. Stock Adjustment, Stock Transfer, Goods Receipt), he/she can see the detailed ledger entries that caused the qty movement for each item SKU in that document. Every month end, the system will automatically generate the inventory valuation report based on the selected costing method and record the closing balance for each item SKU in each warehouse. This closing balance will be used as the opening balance for the next month. Inventory plugin also provide various reports such as Inventory Movement Report, Inventory Valuation Report, Stock Opname Report, and Item Usage Report to help users monitor and analyze their inventory performance.
- **Procurement**: The second core operations plugin that handle procurement management and is linked tightly with the inventory management handled by inventory plugin. Procurement plugin handle purchase request management, purchase order management, vendor management, vendor quotation management, goods receipt management, accounts payable management, and procurement budget management. Procurement plugin also integrate with Organization plugin to manage sites and warehouses structure along with staff hierarchy structure for approval workflow purpose. Procurement plugin also integrate with Workflow plugin to define the workflow for each document type in the procurement module (e.g. Purchase Request, Purchase Order, Vendor Quotation) along with status transition rules and approver roles definition. Procurement plugin also integrate with Feeder plugin to keep track of all activities performed by the users in the system related to procurement management. Purchase Request document created in procurement module can be converted into Purchase Order document which later will be used to receive goods into inventory module via Goods Receipt document. This way, the procurement process is tightly integrated with the inventory process to ensure accurate stock levels and financial records. Procurement plugin also provide various reports such as Purchase Request Report, Purchase Order Report, Vendor Performance Report, and Procurement Budget Report to help users monitor and analyze their procurement performance.
- **Registrar**: Document (transaction type is called a Document. E.g: Purchase Order, Purchase Request, Inventory Adjustment) numbering patterns and registration management. Each document type can have it own numbering pattern defined in the Registrar plugin. The default pattern is as follows: SITECODE-DOCUMENTCODE-YYYY-##### (e.g. HQ-PR-2024-00001). Each document type can also have its own prefix and suffix defined in the Registrar plugin. Each document may have more than one status (Draft, Submitted, Reviewed, Approved, Rejected, Cancelled, Completed) that can be tracked and managed. Some status transition will require approval from staff with approver permission while some status transition can be done by the creator itself. Document status in-transition is also defined in the Workflow plugin. Status transition history is also recorded and can be viewed in the document detail page and can have a maximum number of days to perform the approval action before it is considered overdue and later will fallback to Draft status. Only document in Draft status can be edited or deleted. Registrar plugin also keep tracked of all issued document numbers to avoid duplication even those document is later cancelled or deleted (delete action will only render the document unseen from the interface but the record remains in the database for auditing purposes). Running number for each document type cam be set to reset yearly or can be continuous without reset. if the reset interval is yearly, the year part in the document number pattern will automatically update each year and the reset process is done automatically by the system at the beginning of each year.
- **PettyCash**: -- KIV --
- **Workflow**: This plugin keep tracks of every workflow definition and status transition rules. Each document type can have its own workflow definition with multiple status and transition rules defined. Each status transition can have its own set of approver roles defined. Only staff with the approver role assigned to the document type can perform the approval action for that document type. Workflow plugin also keep track of the history of status transition for each document and record the staff who performed the action along with timestamp. Each workflow changes a document status from status A to status B and in transition status. A document must be in only one active workflow at any time. A document can only be approved by staff with approver role assigned to that document type and who is in the hierarchy above the creator staff. A document can have multiple levels of approval depending on the hierarchy structure defined in the Organization plugin. as an example, a Purchase Request document created by a staff can be approved by his/her manager, and then by the department head, and then by the finance manager, depending on the hierarchy structure defined in the Organization plugin. Each approval action will change the document status to the next status defined in the workflow definition until it reaches the final status (e.g. Approved or Rejected). Each status transition can also have its own set of rules defined (e.g. maximum amount that can be approved by a certain approver role). If a document is rejected, it will be reverted back to either Draft status or previous status (defined in the workflow definition). An approved action will not need the user to mention the reason but all rejected action must have a reason mentioned by the approver staff. Each workflow definition will have a unique workflow code that can be referenced by other plugins (e.g. Inventory, Procurement) to determine the workflow for a specific document type and its current status.
- **Feeder**: Feeder plugin is like a logger that keep tracks of all activities performed by the users in the system. Each activity is recorded as a feed item with details such as user who performed the action, action type, target model, timestamp, and additional data. Feeder plugin uses morphTo relationship to associate feed items with any model in the system. As an example, when a user creates a Purchase Request document, a feed item is created with the user id, action type (create), target model (Purchase Request), and timestamp. This feed item can later be viewed in the activity log of the user or the target model. Feeder plugin also provides methods to retrieve feed items based on various criteria such as user, action type, target model, and date range. This allows for easy tracking and auditing of user activities in the system. Feeder plugin also provide a sidebar view component that can be integrated into other plugins to display recent activities related to a specific model or user. This sidebar component can be customized to show different types of feed items and can be filtered based on user preferences. This plugin takes away the responsibility of each plugin to implement its own activity tracking mechanism and provides a centralized solution for activity logging across the entire system.

## Common Patterns
- **Morphable relationships**: Many models use `morphTo` for flexible associations (e.g., `Feed` model can attach to any feedable model)
- **Backend user integration**: Extensive use of `BackendAuth::getUser()` for user context in business logic
- **Validation traits**: Models consistently use `\October\Rain\Database\Traits\Validation`

## References
- See `README.md` in root, themes, and plugins for more details.
- Plugin architecture overview in `plugins/omsb/README.md` with detailed documentation status
- For OctoberCMS plugin's development: https://docs.octobercms.com/4.x/extend/system/plugins.html
- For OctoberCMS conventions, see https://octobercms.com/help/guidelines/developer
- For OctoberCMS quality guidelines: https://octobercms.com/help/guidelines/quality
- For OctoberCMS API reference: https://docs.octobercms.com/4.x/element/form-fields.html
- For Laravel Mix/Tailwind, see theme `README.md` and `tailwind.config.js`.

---

**When in doubt, follow the structure and conventions of existing modules/plugins.**
